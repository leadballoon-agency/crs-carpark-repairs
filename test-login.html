<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Login - CRS</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        h1 {
            color: #FFD700;
        }
        
        h2 {
            color: #FFD700;
            font-size: 1.2rem;
            margin-top: 0;
        }
        
        button {
            background: #FFD700;
            color: #000;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 1rem;
            margin-bottom: 1rem;
        }
        
        button:hover {
            background: #FFC700;
        }
        
        .result {
            background: #000;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .success {
            border: 2px solid #4CAF50;
        }
        
        .error {
            border: 2px solid #f44336;
        }
        
        .info {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <h1>ðŸ”§ Login Test & Debug</h1>
    
    <div class="info">
        <strong>Test Accounts:</strong><br>
        1. Super Admin: mark@leadballoon.co.uk / admin123!!<br>
        2. Admin: admin@crs.com / admin123<br>
        3. Demo Client: demo@mcdonalds.com / demo123
    </div>
    
    <div class="test-section">
        <h2>1. Test API Health</h2>
        <button onclick="testHealth()">Test Health Endpoint</button>
        <button onclick="testDatabase()">Test Database Connection</button>
        <div id="healthResult" class="result" style="display:none;"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Test Authentication Endpoints</h2>
        <button onclick="testLogin('mark@leadballoon.co.uk', 'admin123!!')">Test Super Admin Login</button>
        <button onclick="testLogin('admin@crs.com', 'admin123')">Test Admin Login</button>
        <button onclick="testLogin('demo@mcdonalds.com', 'demo123')">Test Demo Login</button>
        <button onclick="testLogin('wrong@email.com', 'wrongpass')">Test Invalid Login</button>
        <div id="authResult" class="result" style="display:none;"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Direct API Test</h2>
        <button onclick="testDirectAPI()">Test Direct API Call</button>
        <div id="directResult" class="result" style="display:none;"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Test Portal API</h2>
        <button onclick="testPortalAPI()">Test Portal API Login</button>
        <div id="portalResult" class="result" style="display:none;"></div>
    </div>
    
    <script>
        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = 'result ' + (isError ? 'error' : 'success');
            element.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        }
        
        async function testHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                showResult('healthResult', data);
            } catch (error) {
                showResult('healthResult', error.message, true);
            }
        }
        
        async function testDatabase() {
            try {
                const response = await fetch('/api/test-db');
                const data = await response.json();
                showResult('healthResult', data);
            } catch (error) {
                showResult('healthResult', error.message, true);
            }
        }
        
        async function testLogin(email, password) {
            try {
                console.log('Testing login for:', email);
                
                const response = await fetch('/api/main/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult('authResult', {
                        status: 'Login successful!',
                        user: data.user,
                        token: data.token ? 'Token received' : 'No token'
                    });
                } else {
                    showResult('authResult', {
                        status: 'Login failed',
                        error: data.error,
                        message: data.message
                    }, true);
                }
            } catch (error) {
                showResult('authResult', {
                    error: 'Request failed',
                    message: error.message
                }, true);
            }
        }
        
        async function testDirectAPI() {
            try {
                // Test all variations of the API endpoint
                const endpoints = [
                    '/api/main/auth/login',
                    '/api/auth/login',
                    '/api/main'
                ];
                
                const results = [];
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                email: 'admin@crs.com',
                                password: 'admin123'
                            })
                        });
                        
                        results.push({
                            endpoint,
                            status: response.status,
                            statusText: response.statusText,
                            ok: response.ok
                        });
                    } catch (err) {
                        results.push({
                            endpoint,
                            error: err.message
                        });
                    }
                }
                
                showResult('directResult', results);
            } catch (error) {
                showResult('directResult', error.message, true);
            }
        }
        
        async function testPortalAPI() {
            try {
                // Load the portal API
                const script = document.createElement('script');
                script.src = '/js/portal-api.js';
                document.head.appendChild(script);
                
                script.onload = async () => {
                    const api = new PortalAPI();
                    
                    try {
                        const result = await api.login('admin@crs.com', 'admin123');
                        showResult('portalResult', {
                            status: 'Portal API login successful',
                            user: result.user
                        });
                    } catch (error) {
                        showResult('portalResult', {
                            status: 'Portal API login failed',
                            error: error.message
                        }, true);
                    }
                };
            } catch (error) {
                showResult('portalResult', error.message, true);
            }
        }
        
        // Auto-run health check on load
        window.addEventListener('load', () => {
            testHealth();
        });
    </script>
</body>
</html>